<?php
require_once "models/UsuarioModel.php";

class Controlador_registro
{
    private usuario_model $usuarioModel;

    public function __construct()
    {
        $this->usuarioModel = new usuario_model();
    }

    public function registrar()
    {
        if ($_SERVER["REQUEST_METHOD"] !== "POST") {
            require "vistas/vista_registro.php";
            return;
        }

        // 1. Recoger datos
        $nombre = trim($_POST["nombre"] ?? "");
        $email = trim($_POST["email"] ?? "");
        $pass = $_POST["pass"] ?? "";
        $passRepeat = $_POST["pass_repeat"] ?? "";

        // 2. Validaciones básicas
        if ($pass !== $passRepeat) {
            $error = "Las contraseñas no coinciden";
            require "vistas/vista_registro.php";
            return;
        }

        if (strlen($pass) < 6) {
            $error = "La contraseña debe tener al menos 6 caracteres";
            require "vistas/vista_registro.php";
            return;
        }

        // 3. Datos tal y como los espera tu API Java
        $usuario = [
            "nombre" => $nombre,
            "email" => $email,
            "pass" => $pass,
            "biografia" => "",
            "fotoPerfilBase64" => null
        ];

        // 4. Llamada a la API Java
        $respuesta = $this->usuarioModel->registrar($usuario);

        // 5. Interpretar respuesta HTTP
        if ($respuesta["code"] === 200) {
            header("Location: index.php?c=Login&m=mostrar&registro=ok");
            exit;
        }

        if ($respuesta["code"] === 409) {
            $error = "El usuario o el email ya existen";
        } else {
            $error = "Error al registrar el usuario";
        }

        require "vistas/vista_registro.php";
    }
}